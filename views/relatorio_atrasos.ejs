<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RelatÃ³rio de Atrasos</title>

  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >

  <!-- Bootstrap Icons (para o botÃ£o voltar ao topo e outros Ã­cones) -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    rel="stylesheet"
  >

  <style>
    @media print {
      .no-print {
        display: none !important;
      }
    }

    /* BotÃ£o flutuante de voltar ao topo */
    #btnTopo {
      display: none; /* escondido atÃ© rolar a pÃ¡gina */
      position: fixed;
      bottom: 25px;
      right: 25px;
      z-index: 99;
      border: none;
      outline: none;
      background-color: #0dcaf0;
      color: white;
      cursor: pointer;
      padding: 12px 15px;
      border-radius: 50%;
      font-size: 18px;
      justify-content: center;
      align-items: center;
      box-shadow: 0px 3px 10px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
    }

    #btnTopo:hover {
      background-color: #0bb3d8;
      transform: scale(1.1);
    }
  </style>
</head>

<body class="bg-light">
  <div class="container mt-5">
    <div class="card shadow">
      <div class="card-header bg-primary text-white">
        <h3 class="mb-0 text-center">RelatÃ³rio de Atrasos dos Alunos</h3>
      </div>
      <div class="card-body">
        
        <!-- FormulÃ¡rio -->
        <form action="/relatorio_atrasos" method="GET" class="row g-3 mb-4 no-print">
          <div class="col-md-4">
            <label for="mes" class="form-label">MÃªs:</label>
            <input type="number" id="mes" name="mes" class="form-control" min="1" max="12" required placeholder="Ex: 10">
          </div>
          <div class="col-md-4">
            <label for="ano" class="form-label">Ano:</label>
            <input type="number" id="ano" name="ano" class="form-control" min="2020" max="2100" required placeholder="Ex: 2025">
          </div>
          <div class="col-md-4 d-flex align-items-end">
            <button type="submit" class="btn btn-success w-100">Gerar RelatÃ³rio</button>
          </div>

          <div class="position-relative mb-3">
            <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-2 text-muted"></i>
            <input type="text" class="form-control form-control-sm ps-5" id="searchInput"
              placeholder="Buscar por Nome..." style="border: 1px solid rgb(0, 119, 255);">
          </div>
        </form>

        <% if (mensagem && mes && ano) { %>
  <p style="text-align:center; color: #777; font-style: italic;">
    <%= mensagem %>
Â Â </p>
<%Â }Â %>

        <!-- Resultados -->
        <% if (resultados && resultados.length > 0) { %>
          <h5 class="mt-4 mb-3 text-center text-secondary">
            Resultados â€” <%= mes %>/<%= ano %>
          </h5>

          <div class="table-responsive">
            <table class="table table-striped table-bordered align-middle text-center">
              <thead class="table-primary">
                <tr>
                  <th>Aluno</th>
                  <th>Total de Atraso</th>
                </tr>
              </thead>
              <tbody>
  <% resultados.forEach(r => { %>
    <tr>
      <td><%= r.nome %></td>
      <% 
        const horas = Math.floor(r.total_minutos_atraso / 60);
        const minutos = r.total_minutos_atraso % 60;
      %>
      <td><%= horas > 0 ? `${horas}h ${minutos}min` : `${minutos}min` %></td>
    </tr>
  <% }) %>
</tbody>
            </table>

            <!-- BotÃµes -->
            <div class="mt-3 no-print">
              <button class="btn btn-info" onclick="window.print()">
                <i class="bi bi-printer"></i> Imprimir Lista
              </button>
              <a href="/" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Voltar
              </a>
            </div>
          </div>
        <% } else if (resultados && resultados.length === 0) { %>
          <div class="alert alert-warning text-center mt-4">
            Nenhum atraso encontrado para esse perÃ­odo.
          </div>
        <% } %>
      </div>
    </div>
  </div>

  <!-- BotÃ£o flutuante -->
  <button onclick="voltarAoTopo()" id="btnTopo" class="no-print">
    <i class="bi bi-arrow-up"></i>
  </button>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ðŸ”Ž Filtro de busca
    document.getElementById("searchInput").addEventListener("keyup", function () {
      const input = this.value.toLowerCase();
      const rows = document.querySelectorAll("table tbody tr");

      rows.forEach(row => {
        const nome = row.children[0].textContent.toLowerCase();
        row.style.display = nome.includes(input) ? "" : "none";
      });
    });

    // ðŸŽ¯ Mostrar/esconder botÃ£o de topo
    window.onscroll = function() { scrollFunction() };

    function scrollFunction() {
      const btn = document.getElementById("btnTopo");
      if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
        btn.style.display = "flex";
      } else {
        btn.style.display = "none";
      }
    }

    // â¬† Voltar suavemente ao topo
    function voltarAoTopo() {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  </script>
</body>
</html>
